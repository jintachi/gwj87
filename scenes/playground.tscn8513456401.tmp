[gd_scene load_steps=26 format=3 uid="uid://wepmsqh4axsa"]

[ext_resource type="Script" uid="uid://bc0nyx1kmau85" path="res://mechanics/entities/player.gd" id="1_qchbg"]
[ext_resource type="Script" uid="uid://cm18cx1ktfan0" path="res://mechanics/effects/area_of_effect.gd" id="2_q8s1k"]
[ext_resource type="Shader" uid="uid://b4qs845i3go35" path="res://shaders/color.gdshader" id="3_kddj0"]
[ext_resource type="Resource" uid="uid://dcl8e5e0jbdld" path="res://IceEffect.tres" id="3_mm0a5"]
[ext_resource type="Script" uid="uid://bq4mi00oaovbm" path="res://mechanics/inventory/inventory_slot.gd" id="5_mrac1"]
[ext_resource type="Resource" uid="uid://c2oy1qdb1nyjc" path="res://assets/player_stats.tres" id="5_o6wi6"]
[ext_resource type="Script" uid="uid://bov44tgaen1t" path="res://mechanics/inventory/inventory.gd" id="6_2q4k0"]
[ext_resource type="Texture2D" uid="uid://c077toxp08etq" path="res://assets/sprites/camel.png" id="6_o6wi6"]
[ext_resource type="Script" uid="uid://cnibtsckb1myb" path="res://mechanics/inventory/test_shooter.gd" id="8_2q4k0"]
[ext_resource type="PackedScene" uid="uid://bs3qoxmweqlyb" path="res://bullet.tscn" id="8_x1amm"]

[sub_resource type="FastNoiseLite" id="FastNoiseLite_kddj0"]

[sub_resource type="NoiseTexture2D" id="NoiseTexture2D_q8s1k"]
noise = SubResource("FastNoiseLite_kddj0")

[sub_resource type="ShaderMaterial" id="ShaderMaterial_q8s1k"]
shader = ExtResource("3_kddj0")
shader_parameter/color = Color(0, 0.5354038, 0.96128076, 1)

[sub_resource type="PlaceholderTexture2D" id="PlaceholderTexture2D_mm0a5"]
size = Vector2(128, 128)

[sub_resource type="RectangleShape2D" id="RectangleShape2D_mm0a5"]
size = Vector2(128, 128)

[sub_resource type="Resource" id="Resource_x1amm"]
script = ExtResource("6_2q4k0")
size = 30
metadata/_custom_type_script = "uid://bov44tgaen1t"

[sub_resource type="Resource" id="Resource_mrac1"]
script = ExtResource("5_mrac1")
slot_type = 1
metadata/_custom_type_script = "uid://bq4mi00oaovbm"

[sub_resource type="Resource" id="Resource_k63md"]
script = ExtResource("8_2q4k0")
bullet = ExtResource("8_x1amm")
slot_type = 5
metadata/_custom_type_script = "uid://cnibtsckb1myb"

[sub_resource type="Resource" id="Resource_2q4k0"]
script = ExtResource("5_mrac1")
slot_type = 5
item = SubResource("Resource_k63md")
metadata/_custom_type_script = "uid://bq4mi00oaovbm"

[sub_resource type="Resource" id="Resource_2bfhc"]
script = ExtResource("5_mrac1")
slot_type = 2
metadata/_custom_type_script = "uid://bq4mi00oaovbm"

[sub_resource type="Resource" id="Resource_osidk"]
script = ExtResource("5_mrac1")
slot_type = 3
metadata/_custom_type_script = "uid://bq4mi00oaovbm"

[sub_resource type="Resource" id="Resource_rlvb3"]
script = ExtResource("5_mrac1")
slot_type = 4
metadata/_custom_type_script = "uid://bq4mi00oaovbm"

[sub_resource type="PlaceholderTexture2D" id="PlaceholderTexture2D_qchbg"]
size = Vector2(32, 48)

[sub_resource type="CircleShape2D" id="CircleShape2D_kddj0"]
radius = 16.0

[sub_resource type="GDScript" id="GDScript_x1amm"]
script/source = "extends Node
class_name MJRunner

enum ModelSelection { CAVE, DUNGEON_GROWTH, WAVE_BRICK_WALL }

@export var model_to_run: ModelSelection = ModelSelection.CAVE
@export var grid_width: int = 40
@export var grid_height: int = 40
@export var grid_depth: int = 1
@export var visualize_gif_steps: bool = false

# Model-specific properties, will be overridden by _generate_and_setup_model
var grid_values: String
var set_origin: bool = false
var unions: Dictionary = {}

var model: MJSequenceNode
var grid: MJGrid
var current_branch: MJBranch
var is_running: bool = false
var changes: Array[Vector3] # List of (x, y, z) tuples
var first: Array[int] # Index of first change for each step
var counter: int = 0
var random: RandomNumberGenerator = RandomNumberGenerator.new()

func _ready():
	random.randomize() # Initialize the random number generator
	run()

func _generate_and_setup_model():
	# 1. Set model-specific properties
	match model_to_run:
		ModelSelection.CAVE:
			grid_values = \"DA\"
			set_origin = false
			unions = {}
			model = ModelGenerators.generate_cave()
		ModelSelection.DUNGEON_GROWTH:
			grid_values = \"WRBUPY\"
			set_origin = true
			unions = {\"?\": \"BR\"}
			model = ModelGenerators.generate_dungeon_growth()
		ModelSelection.WAVE_BRICK_WALL:
			grid_values = \"B\" # This is the input grid value
			set_origin = false
			unions = {}
			model = ModelGenerators.generate_wave_brick_wall()
			# The WFC node itself will use different values internally
	
	# 2. Create and configure grid
	grid = MJGrid.new(grid_width, grid_height, grid_depth, grid_values)
	for symbol in unions:
		grid.add_union(symbol, unions[symbol])
	if set_origin:
		var x = int(grid_width / 2)
		var y = int(grid_height / 2)
		var z = int(grid_depth / 2)
		grid.set_state(x, y, z, 1) # In MJ, origin usually sets state to 1

	# 3. Parse model rules against the new grid
	if model:
		if not _parse_model_rules(model, grid):
			push_error(\"Failed to parse model rules. Model will not run.\")
			model = null # Prevent further execution if parsing failed
	
	print(\"Model '\", ModelSelection.keys()[model_to_run], \"' generated and rules parsed.\")

func _parse_model_rules(node: MJNode, current_grid: MJGrid) -> bool:
	# MapNode handles its own children's parsing, so we don't descend.
	if node is MJMapNode:
		(node as MJMapNode).parse_rules(current_grid)

	if node is MJRuleNode:
		for rule: MJRule in (node as MJRuleNode).rules:
			rule.parse(current_grid)
	
	if node is MJConvolutionNode:
		for rule: MJConvolutionRule in (node as MJConvolutionNode).rules:
			rule.parse(current_grid)
	
	if node is MJPathNode:
		(node as MJPathNode)._parse_waves(current_grid)

	if node is MJBranch:
		if node is MJOverlapNode:
			if not (node as MJOverlapNode).build_model(current_grid):
				push_error(\"Failed to build model for OverlapNode.\")
				return false # Propagate error
		elif node is MJTileNode:
			if not (node as MJTileNode).build_model(current_grid):
				push_error(\"Failed to build model for TileNode.\")
				return false # Propagate error
		
		for child_node: MJNode in (node as MJBranch).nodes:
			if not _parse_model_rules(child_node, current_grid):
				return false # Propagate error
	return true # Indicate success

func reset():
	_generate_and_setup_model()
	
	if model:
		model.reset()
		current_branch = model
	
	changes = []
	first = [0]
	counter = 0
	# random = RandomNumberGenerator.new() # Already initialized in _ready
	is_running = true
	print(\"Runner reset.\")

func run_step():
	if not is_running or not current_branch:
		print(\"Runner is not running or no model is set.\")
		return

	var acted = current_branch.go(grid, self)
	
	if acted:
		counter += 1
		first.append(changes.size())
		# In a real app, you might want to yield here to allow for visualization
		# print(\"Step \", counter, \": Success\")
	else:
		# The current branch is finished, move up the tree
		if current_branch.parent_branch:
			current_branch = current_branch.parent_branch
			# After moving up, the parent branch needs to advance its own node index
			current_branch.current_node_index += 1
			# Immediately try to run the next step from the parent's context
			run_step()
		else:
			is_running = false
			
			var g = grid
			for y in range(g.MY):
				var row_str = \"\"
				for x in range(g.MX):
					var value = g.state[x + y * g.MX]
					var char = g.characters[value]
					row_str += (\"-\" if char == \"D\" else \"#\") + \"\"
				print(row_str)
			print(\"---\")
			print(\"Finished in \", counter, \" steps.\")

func run():
	reset()
	while is_running:
		run_step()
	return grid.state
"

[node name="Main" type="Node"]

[node name="Ground" type="Sprite2D" parent="."]
modulate = Color(0.26130536, 0.08462194, 0.012531371, 1)
position = Vector2(-32, 21.75002)
scale = Vector2(2.4804688, 1.6201173)
texture = SubResource("NoiseTexture2D_q8s1k")

[node name="Sprite2D" type="Sprite2D" parent="."]
material = SubResource("ShaderMaterial_q8s1k")
position = Vector2(-194, 35)
texture = SubResource("PlaceholderTexture2D_mm0a5")

[node name="Area2D" type="Area2D" parent="Sprite2D"]
script = ExtResource("2_q8s1k")
effect = ExtResource("3_mm0a5")

[node name="CollisionShape2D" type="CollisionShape2D" parent="Sprite2D/Area2D"]
shape = SubResource("RectangleShape2D_mm0a5")

[node name="Player" type="CharacterBody2D" parent="."]
motion_mode = 1
script = ExtResource("1_qchbg")
general_inventory = SubResource("Resource_x1amm")
data = ExtResource("5_o6wi6")
head_item = SubResource("Resource_mrac1")
weapon_item = SubResource("Resource_2q4k0")
armor_item = SubResource("Resource_2bfhc")
consumable_item = SubResource("Resource_osidk")
ammo_item = SubResource("Resource_rlvb3")

[node name="Sprite2D" type="Sprite2D" parent="Player"]
texture_repeat = 2
texture = SubResource("PlaceholderTexture2D_qchbg")
offset = Vector2(0, -24)

[node name="Camera2D" type="Camera2D" parent="Player"]
process_callback = 0
position_smoothing_enabled = true

[node name="CollisionShape2D" type="CollisionShape2D" parent="Player"]
shape = SubResource("CircleShape2D_kddj0")

[node name="CharacterBody2D" type="CharacterBody2D" parent="."]
position = Vector2(148, 130)

[node name="Sprite2D" type="Sprite2D" parent="CharacterBody2D"]
texture_repeat = 2
texture = ExtResource("6_o6wi6")
offset = Vector2(0, -24)

[node name="CollisionShape2D" type="CollisionShape2D" parent="CharacterBody2D"]
shape = SubResource("CircleShape2D_kddj0")

[node name="MJRunner" type="Node" parent="."]
script = SubResource("GDScript_x1amm")
